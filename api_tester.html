<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure File Sharing - API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .auth-section {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 30px;
        }

        .auth-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .token-display {
            margin-top: 15px;
            padding: 15px;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
        }

        .main-content {
            padding: 30px;
        }

        .endpoint-section {
            margin-bottom: 40px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .endpoint-header {
            background: #f1f5f9;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .endpoint-header:hover {
            background: #e2e8f0;
        }

        .endpoint-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .method-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            color: white;
        }

        .method-get { background: #10b981; }
        .method-post { background: #3b82f6; }
        .method-put { background: #f59e0b; }
        .method-delete { background: #ef4444; }

        .endpoint-path {
            font-family: monospace;
            font-weight: 600;
            color: #374151;
        }

        .endpoint-description {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .endpoint-content {
            padding: 20px;
            display: none;
        }

        .endpoint-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .form-section h4 {
            margin-bottom: 15px;
            color: #374151;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .file-input {
            margin-bottom: 15px;
        }

        .response-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            color: white;
        }

        .status-200 { background: #10b981; }
        .status-201 { background: #10b981; }
        .status-400 { background: #f59e0b; }
        .status-401 { background: #ef4444; }
        .status-403 { background: #ef4444; }
        .status-404 { background: #ef4444; }
        .status-500 { background: #ef4444; }
        .status-0 { background: #6b7280; }

        .response-body {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .toggle-icon {
            transition: transform 0.2s;
        }

        .toggle-icon.active {
            transform: rotate(90deg);
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

        .credential-helper {
            background: linear-gradient(145deg, #fef3c7 0%, #fed7aa 100%);
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.85rem;
        }

        .credential-helper strong {
            color: #92400e;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .workflow-guide {
            background: linear-gradient(145deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .workflow-guide h3 {
            color: #166534;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .workflow-steps {
            list-style: none;
            padding: 0;
        }

        .workflow-steps li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: #059669;
        }

        .workflow-steps li::before {
            content: "✓";
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🔧 API Tester</h1>
            <p>Test all endpoints of the Secure File Sharing System</p>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section">
            <div class="auth-controls">
                <div class="input-group">
                    <label>User Type</label>
                    <select id="userType">
                        <option value="ops">Ops User</option>
                        <option value="client">Client User</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="authEmail" value="ops@example.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="authPassword" value="ops123">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">Login</button>
                <button class="btn btn-secondary" onclick="clearAuth()">Clear Token</button>
            </div>
            <div id="tokenDisplay" class="token-display hidden">
                <strong>Auth Token:</strong> <span id="tokenValue"></span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="main-content">
            <!-- Workflow Guide -->
            <div class="workflow-guide">
                <h3>🚀 API Testing Workflow Guide</h3>
                <ul class="workflow-steps">
                    <li>Start with "🩺 Health Check" to verify server connection</li>
                    <li>Use "🔐 Quick Ops Login" for admin operations (file upload)</li>
                    <li>Use "👤 Test Client Signup" to create a new client account</li>
                    <li>Use "🔑 Test Client Login" to test client authentication (requires email verification)</li>
                    <li>Use "👥 Switch to Client" to test client-specific endpoints</li>
                    <li>Use "🧪 Run All Tests" for comprehensive automated testing</li>
                </ul>
                <div class="status-info">
                    <strong>💡 Note:</strong> Client accounts need email verification to login. Your system shows "email sending failed" so manual verification may be needed.
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn btn-success" onclick="testHealthCheck()">🩺 Health Check</button>
                <button class="btn btn-success" onclick="testOpsLogin()">🔐 Quick Ops Login</button>
                <button class="btn btn-success" onclick="testClientSignup()">👤 Test Client Signup</button>
                <button class="btn btn-success" onclick="testClientLogin()">🔑 Test Client Login</button>
                <button class="btn btn-success" onclick="switchToClientMode()">👥 Switch to Client</button>
                <button class="btn btn-success" onclick="runFullTestSuite()">🧪 Run All Tests</button>
                <button class="btn btn-success" onclick="openAllEndpoints()">📂 Expand All</button>
                <button class="btn btn-secondary" onclick="closeAllEndpoints()">📁 Collapse All</button>
                <button class="btn btn-secondary" onclick="showDebugInfo()">🔍 Debug Info</button>
                <button class="btn btn-secondary" onclick="explainClientLoginRequirements()">📖 Client Login Help</button>
            </div>

            <!-- API Endpoints -->
            <div id="apiEndpoints">
                <!-- Endpoints will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        let currentUserType = 'ops';

        // API Endpoints Configuration
        const apiEndpoints = [
            {
                category: "Health & Info",
                endpoints: [
                    {
                        method: "GET",
                        path: "/health",
                        description: "Check server health status",
                        requiresAuth: false,
                        parameters: []
                    },
                    {
                        method: "GET",
                        path: "/api",
                        description: "Get API information and available endpoints",
                        requiresAuth: false,
                        parameters: []
                    }
                ]
            },
            {
                category: "Authentication",
                endpoints: [
                    {
                        method: "POST",
                        path: "/api/auth/ops/login",
                        description: "Login as Ops user",
                        requiresAuth: false,
                        parameters: [
                            { name: "email", type: "email", required: true, value: "ops@example.com" },
                            { name: "password", type: "password", required: true, value: "ops123" }
                        ]
                    },
                    {
                        method: "POST",
                        path: "/api/auth/client/login",
                        description: "Login as Client user",
                        requiresAuth: false,
                        parameters: [
                            { name: "email", type: "email", required: true, value: "" },
                            { name: "password", type: "password", required: true, value: "" }
                        ]
                    },
                    {
                        method: "POST",
                        path: "/api/auth/client/signup",
                        description: "Register new client user",
                        requiresAuth: false,
                        parameters: [
                            { name: "email", type: "email", required: true, value: "" },
                            { name: "password", type: "password", required: true, value: "" }
                        ]
                    },
                    {
                        method: "POST",
                        path: "/api/auth/client/verify",
                        description: "Verify client email with token",
                        requiresAuth: false,
                        parameters: [
                            { name: "email", type: "email", required: true, value: "" },
                            { name: "token", type: "text", required: true, value: "" }
                        ]
                    }
                ]
            },
            {
                category: "File Operations (Ops)",
                endpoints: [
                    {
                        method: "POST",
                        path: "/api/ops/upload",
                        description: "Upload a file (.pptx, .docx, .xlsx only)",
                        requiresAuth: true,
                        userType: "ops",
                        parameters: [],
                        fileUpload: true
                    }
                ]
            },
            {
                category: "File Operations (Client)",
                endpoints: [
                    {
                        method: "GET",
                        path: "/api/client/files",
                        description: "List all available files",
                        requiresAuth: true,
                        userType: "client",
                        parameters: []
                    },
                    {
                        method: "GET",
                        path: "/api/client/download-file/{file_id}",
                        description: "Generate secure download link for a file",
                        requiresAuth: true,
                        userType: "client",
                        parameters: [
                            { name: "file_id", type: "number", required: true, value: "", placeholder: "Enter file ID" }
                        ]
                    }
                ]
            },
            {
                category: "File Download",
                endpoints: [
                    {
                        method: "GET",
                        path: "/download-file/{token}",
                        description: "Download file using encrypted token (single-use)",
                        requiresAuth: false,
                        parameters: [
                            { name: "token", type: "text", required: true, value: "", placeholder: "Enter encrypted download token" }
                        ],
                        isDownload: true
                    }
                ]
            }
        ];

        // Initialize the API tester
        function initializeApiTester() {
            const container = document.getElementById('apiEndpoints');
            let globalEndpointIndex = 0;
            
            apiEndpoints.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `
                    <h2 style="margin: 30px 0 20px 0; color: #374151; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
                        ${category.category}
                    </h2>
                `;
                container.appendChild(categoryDiv);

                category.endpoints.forEach((endpoint) => {
                    const endpointDiv = createEndpointElement(endpoint, globalEndpointIndex);
                    container.appendChild(endpointDiv);
                    globalEndpointIndex++;
                });
            });

            // Update user type selector
            document.getElementById('userType').addEventListener('change', function() {
                currentUserType = this.value;
                if (this.value === 'ops') {
                    document.getElementById('authEmail').value = 'ops@example.com';
                    document.getElementById('authPassword').value = 'ops123';
                } else {
                    document.getElementById('authEmail').value = '';
                    document.getElementById('authPassword').value = '';
                }
            });
        }

        function createEndpointElement(endpoint, index) {
            const methodClass = `method-${endpoint.method.toLowerCase()}`;
            const endpointId = `endpoint-${index}`;
            
            const div = document.createElement('div');
            div.className = 'endpoint-section';
            
            let parametersHtml = '';
            let fileUploadHtml = '';
            
            if (endpoint.fileUpload) {
                fileUploadHtml = `
                    <div class="form-section">
                        <h4>File Upload</h4>
                        <div class="form-group">
                            <label>Select File (.pptx, .docx, .xlsx)</label>
                            <input type="file" id="file-${index}" accept=".pptx,.docx,.xlsx">
                        </div>
                    </div>
                `;
            }
            
            if (endpoint.parameters && endpoint.parameters.length > 0) {
                const paramFields = endpoint.parameters.map((param, paramIndex) => `
                    <div class="form-group">
                        <label>${param.name} ${param.required ? '*' : ''}</label>
                        <input 
                            type="${param.type}" 
                            id="param-${index}-${paramIndex}" 
                            value="${param.value || ''}"
                            placeholder="${param.placeholder || param.name}"
                            ${param.required ? 'required' : ''}
                        >
                    </div>
                `).join('');
                
                parametersHtml = `
                    <div class="form-section">
                        <h4>Parameters</h4>
                        ${paramFields}
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="endpoint-header" onclick="toggleEndpoint('${endpointId}')">
                    <div class="endpoint-title">
                        <span class="method-badge ${methodClass}">${endpoint.method}</span>
                        <span class="endpoint-path">${endpoint.path}</span>
                        <span class="endpoint-description">${endpoint.description}</span>
                    </div>
                    <span class="toggle-icon">▶</span>
                </div>
                <div class="endpoint-content" id="${endpointId}">
                    <div class="form-grid">
                        ${parametersHtml}
                        ${fileUploadHtml}
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="executeRequest(${index})">
                            ${endpoint.isDownload ? '📥 Download' : '🚀 Execute'}
                        </button>
                        <button class="btn btn-secondary" onclick="clearResponse(${index})">🧹 Clear</button>
                    </div>
                    <div class="response-section" id="response-${index}" style="display: none;">
                        <div class="response-header">
                            <h4>Response</h4>
                            <span class="status-badge" id="status-${index}"></span>
                        </div>
                        <div class="response-body" id="response-body-${index}"></div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function toggleEndpoint(endpointId) {
            const content = document.getElementById(endpointId);
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            
            content.classList.toggle('active');
            icon.classList.toggle('active');
        }

        function openAllEndpoints() {
            document.querySelectorAll('.endpoint-content').forEach(content => {
                content.classList.add('active');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('active');
            });
        }

        function closeAllEndpoints() {
            document.querySelectorAll('.endpoint-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('active');
            });
        }

        async function authenticate() {
            const userType = document.getElementById('userType').value;
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/auth/${userType}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUserType = userType;
                    document.getElementById('tokenValue').textContent = authToken;
                    document.getElementById('tokenDisplay').classList.remove('hidden');
                    showToast('Authentication successful!', 'success');
                } else {
                    showToast(`Authentication failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast('Authentication error: ' + error.message, 'error');
            }
        }

        function clearAuth() {
            authToken = null;
            document.getElementById('tokenDisplay').classList.add('hidden');
            showToast('Authentication cleared', 'success');
        }

        async function executeRequest(endpointIndex) {
            const endpoint = getAllEndpoints()[endpointIndex];
            
            console.log('Executing endpoint:', endpoint.path, 'Index:', endpointIndex);
            
            if (endpoint.requiresAuth && !authToken) {
                showToast('Authentication required for this endpoint', 'error');
                return;
            }
            
            if (endpoint.userType && endpoint.userType !== currentUserType) {
                showToast(`This endpoint requires ${endpoint.userType} user type`, 'error');
                return;
            }
            
            let url = `http://localhost:5000${endpoint.path}`;
            let body = null;
            const headers = { 'Content-Type': 'application/json' };
            
            if (endpoint.requiresAuth) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            // Handle parameters
            if (endpoint.parameters && endpoint.parameters.length > 0) {
                const params = {};
                let urlParams = url;
                let hasRequiredError = false;
                
                endpoint.parameters.forEach((param, paramIndex) => {
                    const paramElement = document.getElementById(`param-${endpointIndex}-${paramIndex}`);
                    if (!paramElement) {
                        console.error(`Parameter element not found: param-${endpointIndex}-${paramIndex}`);
                        return;
                    }
                    
                    const value = paramElement.value;
                    
                    if (param.required && !value) {
                        showToast(`Parameter ${param.name} is required`, 'error');
                        hasRequiredError = true;
                        return;
                    }
                    
                    if (value) {
                        if (urlParams.includes(`{${param.name}}`)) {
                            urlParams = urlParams.replace(`{${param.name}}`, encodeURIComponent(value));
                        } else {
                            params[param.name] = value;
                        }
                    }
                });
                
                if (hasRequiredError) return;
                
                url = urlParams;
                
                if (endpoint.method !== 'GET' && Object.keys(params).length > 0) {
                    body = JSON.stringify(params);
                }
            }
            
            // Handle file upload
            if (endpoint.fileUpload) {
                const fileInput = document.getElementById(`file-${endpointIndex}`);
                if (!fileInput || !fileInput.files[0]) {
                    showToast('Please select a file to upload', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                body = formData;
                delete headers['Content-Type']; // Let browser set multipart boundary
            }
            
            // Handle download endpoints
            if (endpoint.isDownload) {
                console.log('Opening download URL:', url);
                window.open(url, '_blank');
                return;
            }
            
            console.log('Making request to:', url);
            console.log('Method:', endpoint.method);
            console.log('Headers:', headers);
            console.log('Body:', body);
            
            try {
                showLoading(endpointIndex, true);
                
                const response = await fetch(url, {
                    method: endpoint.method,
                    headers: headers,
                    body: body
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }
                
                console.log('Response status:', response.status);
                console.log('Response data:', responseData);
                
                displayResponse(endpointIndex, response.status, responseData);
                
            } catch (error) {
                console.error('Request error:', error);
                displayResponse(endpointIndex, 0, { error: error.message });
            } finally {
                showLoading(endpointIndex, false);
            }
        }

        function displayResponse(endpointIndex, status, data) {
            const responseSection = document.getElementById(`response-${endpointIndex}`);
            const statusBadge = document.getElementById(`status-${endpointIndex}`);
            const responseBody = document.getElementById(`response-body-${endpointIndex}`);
            
            responseSection.style.display = 'block';
            
            // Set status badge
            statusBadge.textContent = status;
            
            // Determine status class
            let statusClass = 'status-0';
            if (status >= 200 && status < 300) {
                statusClass = `status-${status}`;
            } else if (status >= 400 && status < 500) {
                statusClass = `status-${status}`;
            } else if (status >= 500) {
                statusClass = 'status-500';
            }
            
            statusBadge.className = `status-badge ${statusClass}`;
            
            // Format response body
            responseBody.textContent = typeof data === 'object' 
                ? JSON.stringify(data, null, 2) 
                : data;
        }

        function clearResponse(endpointIndex) {
            const responseSection = document.getElementById(`response-${endpointIndex}`);
            responseSection.style.display = 'none';
        }

        function showLoading(endpointIndex, isLoading) {
            const content = document.getElementById(`endpoint-${endpointIndex}`);
            if (isLoading) {
                content.classList.add('loading');
            } else {
                content.classList.remove('loading');
            }
        }

        function getAllEndpoints() {
            return apiEndpoints.flatMap(category => category.endpoints);
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function explainClientLoginRequirements() {
            const explanation = `
📧 CLIENT LOGIN REQUIREMENTS:

1. EMAIL & PASSWORD: 
   - Use any valid email format
   - Password must meet your system requirements

2. ACCOUNT STATUS:
   - Account must be registered via /api/auth/client/signup
   - Account must be EMAIL VERIFIED before login

3. CURRENT ISSUE:
   - Your system shows "email sending failed"
   - This means verification emails aren't being sent
   - Accounts remain unverified and cannot login

4. SOLUTIONS:
   - Fix email service configuration
   - Manually verify accounts in database
   - Use the ops account for testing (pre-verified)

5. TESTING WORKFLOW:
   - First: Create account with "Test Client Signup"
   - Then: Try login (will fail due to verification)
   - Expected: "Please verify your email before logging in"
            `;
            
            console.log(explanation);
            showToast('📖 Client login requirements logged to console (F12)', 'success');
        }

        // Quick test functions
        async function testHealthCheck() {
            try {
                const response = await fetch('http://localhost:5000/health');
                const data = await response.json();
                showToast('Health check: ' + data.status, 'success');
            } catch (error) {
                showToast('Health check failed: ' + error.message, 'error');
            }
        }

        async function testOpsLogin() {
            document.getElementById('userType').value = 'ops';
            document.getElementById('authEmail').value = 'ops@example.com';
            document.getElementById('authPassword').value = 'ops123';
            await authenticate();
        }

        async function testClientSignup() {
            const testEmail = `test${Date.now()}@example.com`;
            try {
                const response = await fetch('http://localhost:5000/api/auth/client/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: testEmail, 
                        password: 'testpass123' 
                    })
                });
                
                const data = await response.json();
                showToast(`Client signup: ${data.message}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    showToast(`📧 Test email: ${testEmail}`, 'success');
                    // Store test credentials for easy use
                    window.lastTestEmail = testEmail;
                    window.lastTestPassword = 'testpass123';
                    
                    // Auto-fill client login form with test credentials
                    setTimeout(() => {
                        fillClientLoginForm(testEmail, 'testpass123');
                    }, 1000);
                }
            } catch (error) {
                showToast('Signup test failed: ' + error.message, 'error');
            }
        }

        function fillClientLoginForm(email, password) {
            // Find client login endpoint and fill the form
            const allEndpoints = getAllEndpoints();
            const clientLoginIndex = allEndpoints.findIndex(ep => ep.path === '/api/auth/client/login');
            
            if (clientLoginIndex !== -1) {
                const emailField = document.getElementById(`param-${clientLoginIndex}-0`);
                const passwordField = document.getElementById(`param-${clientLoginIndex}-1`);
                
                if (emailField && passwordField) {
                    emailField.value = email;
                    passwordField.value = password;
                    showToast(`✅ Auto-filled client login form with test credentials`, 'success');
                }
            }
        }

        async function testClientLogin() {
            if (!window.lastTestEmail || !window.lastTestPassword) {
                showToast('⚠️ Please run "Test Client Signup" first to create test credentials', 'warning');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/client/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: window.lastTestEmail, 
                        password: window.lastTestPassword 
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 401 && data.message === "Please verify your email before logging in") {
                    showToast('❌ Email verification required. Email sending failed in your system.', 'error');
                    showToast('💡 Try using a verified client account or fix email service', 'warning');
                } else if (response.ok) {
                    authToken = data.access_token;
                    currentUserType = 'client';
                    document.getElementById('tokenValue').textContent = authToken;
                    document.getElementById('tokenDisplay').classList.remove('hidden');
                    showToast('✅ Client login successful!', 'success');
                } else {
                    showToast(`❌ Client login failed: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast('❌ Login test failed: ' + error.message, 'error');
            }
        }

        async function switchToClientMode() {
            document.getElementById('userType').value = 'client';
            currentUserType = 'client';
            document.getElementById('authEmail').value = window.lastTestEmail || '';
            document.getElementById('authPassword').value = window.lastTestPassword || '';
            showToast('🔄 Switched to Client mode', 'success');
        }

        function showDebugInfo() {
            const allEndpoints = getAllEndpoints();
            console.log('Total endpoints:', allEndpoints.length);
            console.log('All endpoints:', allEndpoints);
            console.log('Current auth token:', authToken);
            console.log('Current user type:', currentUserType);
            
            // Check if all endpoint elements exist
            allEndpoints.forEach((endpoint, index) => {
                const element = document.getElementById(`endpoint-${index}`);
                console.log(`Endpoint ${index} (${endpoint.path}):`, element ? 'EXISTS' : 'MISSING');
                
                if (endpoint.parameters) {
                    endpoint.parameters.forEach((param, paramIndex) => {
                        const paramElement = document.getElementById(`param-${index}-${paramIndex}`);
                        console.log(`  Parameter ${param.name}:`, paramElement ? 'EXISTS' : 'MISSING');
                    });
                }
            });
            
            showToast('Debug info logged to console (F12)', 'success');
        }

        async function runFullTestSuite() {
            showToast('Running full test suite...', 'success');
            
            // Open all endpoints first
            openAllEndpoints();
            
            // Test 1: Health Check
            await testHealthCheck();
            await sleep(1000);
            
            // Test 2: API Info
            const allEndpoints = getAllEndpoints();
            const apiInfoIndex = allEndpoints.findIndex(ep => ep.path === '/api');
            if (apiInfoIndex !== -1) {
                await executeRequest(apiInfoIndex);
                await sleep(1000);
            }
            
            // Test 3: Ops Login
            await testOpsLogin();
            await sleep(1000);
            
            // Test 4: Client Signup
            await testClientSignup();
            await sleep(1000);
            
            showToast('Test suite completed! Check results below.', 'success');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApiTester);
    </script>
</body>
</html>
